import {FastifyPluginAsync} from 'fastify';
import {randomBytes} from 'node:crypto';
import fp from 'fastify-plugin';

const {NODE_ENV} = process.env;
let {JWT_SECRET} = process.env;

const plugin: FastifyPluginAsync = async server => {
  if (!JWT_SECRET) {
    const message = 'JWT_SECRET environment variable is not set';

    if (NODE_ENV === 'development') {
      JWT_SECRET = randomBytes(32).toString('base64');
      console.warn(`${message}, using autogenerated key: ${JWT_SECRET}`);
    } else throw new Error(message);
  }

  void server.register(import('@fastify/jwt'), {secret: JWT_SECRET});

  server.decorate('authenticate', async request => {
    await request.jwtVerify();
  });
};

export default fp(plugin);
